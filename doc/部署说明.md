# 部署说明

## 部署总览
- 前端：Vue 2 静态站点（包含内置 draw.io 资源），负责 UI 与后端 API 通信。
- 后端：Spring Boot 3 服务，提供 AI 生成与样式修改 API。
- draw.io：优先使用 `frontend/public/drawio/` 内置资源，也可独立部署到静态站点。
- 流程示意：见 `doc/assets/部署流程图.png`。

## 环境准备
- JDK 17（后端运行）
- Maven 3.8+（后端构建）
- Node.js（与 Vue CLI 5 兼容版本，前端构建）
- 可选：Nginx/Apache（生产环境静态资源与反向代理）

## 后端部署
后端配置默认位于 `backend/src/main/resources/application.yml`，核心配置：
- `server.port`：默认 8081
- `server.servlet.context-path`：默认 `/drawio`
- `app.allowed-origins`：前端跨域白名单（按实际域名修改）

构建与运行：
```bash
# 后端构建（跳过测试）
cd backend
mvn -DskipTests package

# 启动后端（替换为实际 jar 名称）
java -jar target/easy-draw-backend-0.1.0-SNAPSHOT.jar
```

Docker（可选，参考 `backend/Dockerfile`）：
```bash
# 构建镜像
docker build -t easy-draw-backend ./backend

# 运行容器（后端监听 8081）
docker run --rm -p 8081:8081 easy-draw-backend
```

## 前端部署
前端构建产物输出到 `frontend/dist/`，构建前需配置环境变量。

建议以 `.env.production` 或 CI 环境变量方式注入：
```ini
# draw.io 静态资源地址（内置资源时建议为 /drawio）
VUE_APP_DRAWIO_BASE_URL=/drawio

# 后端 API 地址（需包含 /drawio/api 前缀）
VUE_APP_API_BASE_URL=https://api.example.com/drawio/api
```

构建命令：
```bash
cd frontend
npm install
npm run build
```

## draw.io 资源部署
两种方式二选一：
- **内置资源**：直接使用 `frontend/public/drawio/`，前端配置 `VUE_APP_DRAWIO_BASE_URL=/drawio`。
- **独立部署**：将 draw.io 静态资源部署到独立站点，需包含 `plugins/mermaid-import.js`，前端配置 `VUE_APP_DRAWIO_BASE_URL=https://drawio.example.com`。

## Nginx 参考（单域名部署）
将前端静态资源与后端 API 置于同一域名，避免跨域：
```nginx
server {
    listen 80;
    server_name example.com;

    # 前端静态资源
    root /var/www/easy-draw/dist;
    index index.html;
    location / {
        try_files $uri /index.html;
    }

    # 后端 API 反向代理（后端 context-path 为 /drawio）
    location /drawio/api/ {
        proxy_pass http://127.0.0.1:8081/drawio/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 部署后验证
- 访问前端页面，配置模型信息（Base URL / API Key / Model）。
- 尝试生成图表，确认能导入到左侧画布。
- 如跨域报错，检查 `app.allowed-origins` 与前端域名是否一致。
