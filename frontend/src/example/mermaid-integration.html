<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw.io Mermaid é›†æˆç¤ºä¾‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-top: 0;
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        #mermaid-input {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .status-section {
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 4px;
            display: none;
        }
        
        .status-section.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .status-section.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .status-section.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }
        
        .iframe-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }
        
        .examples {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .examples h3 {
            margin-top: 0;
            color: #333;
        }
        
        .example-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .example-buttons button {
            padding: 8px 16px;
            background-color: #e9ecef;
            color: #495057;
            font-size: 13px;
        }
        
        .example-buttons button:hover {
            background-color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ Draw.io Mermaid é›†æˆç¤ºä¾‹</h1>
        
        <div class="input-section">
            <label for="mermaid-input">Mermaid æ–‡æœ¬ï¼š</label>
            <textarea id="mermaid-input" placeholder="åœ¨æ­¤è¾“å…¥ Mermaid è¯­æ³•...">flowchart TD
    A[å¼€å§‹] --> B{åˆ¤æ–­æ¡ä»¶}
    B -->|æ˜¯| C[æ‰§è¡Œæ“ä½œ1]
    B -->|å¦| D[æ‰§è¡Œæ“ä½œ2]
    C --> E[ç»“æŸ]
    D --> E</textarea>
        </div>
        
        <div class="options-section" style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="editable-option" checked style="width: 18px; height: 18px;">
                <span>ç”Ÿæˆå¯ç¼–è¾‘çš„åŸç”Ÿå›¾å½¢</span>
            </label>
            <div style="color: #6c757d; font-size: 12px; margin-top: 5px; margin-left: 26px;">
                æ”¯æŒåŸç”Ÿç¼–è¾‘çš„ç±»å‹ï¼šæµç¨‹å›¾ã€æ—¶åºå›¾ã€ç±»å›¾ã€çŠ¶æ€å›¾ã€ERå›¾ã€Gitå›¾ã€æ€ç»´å¯¼å›¾ã€ç”¨æˆ·æ—…ç¨‹å›¾<br>
                ä¸æ”¯æŒçš„ç±»å‹ï¼ˆå¦‚ç”˜ç‰¹å›¾ã€é¥¼å›¾ï¼‰å°†è‡ªåŠ¨ç”Ÿæˆ Mermaid æ•°æ®å›¾å½¢
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="generateDiagram()">ç”Ÿæˆå›¾è¡¨</button>
            <button class="btn-secondary" onclick="clearInput()">æ¸…ç©ºè¾“å…¥</button>
        </div>
        
        <div id="status" class="status-section"></div>
        
        <!-- æ ·å¼ä¿®æ”¹æµ‹è¯•åŒºåŸŸ -->
        <div class="input-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
            <h2 style="color: #333; margin-bottom: 15px;">ğŸ¨ æ ·å¼ä¿®æ”¹ API æµ‹è¯•</h2>
            <label for="style-input">æ ·å¼ä¿®æ”¹ JSON æŒ‡ä»¤ï¼š</label>
            <textarea id="style-input" style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; box-sizing: border-box;" placeholder='è¾“å…¥ JSON æ ¼å¼çš„æ ·å¼ä¿®æ”¹æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š
{
  "action": "modifyStyle",
  "target": "selected",
  "styles": {
    "fillColor": "#FF0000",
    "strokeWidth": 3
  }
}'>{
  "action": "modifyStyle",
  "target": "selected",
  "styles": {
    "fillColor": "#FF6B6B",
    "strokeColor": "#4ECDC4",
    "strokeWidth": 3,
    "rounded": 1
  }
}</textarea>
            
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" onclick="applyStyleModification()">åº”ç”¨æ ·å¼ä¿®æ”¹</button>
                <button class="btn-secondary" onclick="clearStyleInput()">æ¸…ç©ºè¾“å…¥</button>
            </div>
            
            <div id="style-status" class="status-section"></div>
            
            <div class="examples" style="margin-top: 15px;">
                <h3>ğŸ“ æ ·å¼ä¿®æ”¹ç¤ºä¾‹</h3>
                <div class="example-buttons">
                    <button onclick="loadStyleExample('changeColor')">æ”¹å˜é¢œè‰²</button>
                    <button onclick="loadStyleExample('thickenLines')">åŠ ç²—çº¿æ¡</button>
                    <button onclick="loadStyleExample('addShadow')">æ·»åŠ é˜´å½±</button>
                    <button onclick="loadStyleExample('roundCorners')">åœ†è§’æ•ˆæœ</button>
                    <button onclick="loadStyleExample('changeFont')">ä¿®æ”¹å­—ä½“</button>
                    <button onclick="loadStyleExample('relativeOps')">ç›¸å¯¹æ“ä½œ</button>
                    <button onclick="loadStyleExample('edgeArrows')">ç®­å¤´æ ·å¼</button>
                    <button onclick="loadStyleExample('combined')">ç»„åˆä¿®æ”¹</button>
                </div>
            </div>
        </div>
        
        <div class="iframe-container">
            <iframe 
                id="drawio-iframe"
                src="/src/main/webapp/index.html?embed=1&proto=json&spin=1&ui=min&noSaveBtn=1&saveAndExit=0&noExitBtn=1&lang=zh"
                title="Draw.io Editor">
            </iframe>
        </div>
        
        <div class="examples">
            <h3>ğŸ“ ç¤ºä¾‹æ¨¡æ¿</h3>
            <div class="example-buttons">
                <button onclick="loadExample('flowchart')">æµç¨‹å›¾</button>
                <button onclick="loadExample('sequence')">æ—¶åºå›¾</button>
                <button onclick="loadExample('class')">ç±»å›¾</button>
                <button onclick="loadExample('state')">çŠ¶æ€å›¾</button>
                <button onclick="loadExample('er')">ERå›¾</button>
                <button onclick="loadExample('gantt')">ç”˜ç‰¹å›¾</button>
            </div>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('drawio-iframe');
        const statusDiv = document.getElementById('status');
        let iframeReady = false;
        
        // Mermaid ç¤ºä¾‹æ¨¡æ¿
        const examples = {
            flowchart: `flowchart TD
    A[å¼€å§‹] --> B{åˆ¤æ–­æ¡ä»¶}
    B -->|æ˜¯| C[æ‰§è¡Œæ“ä½œ1]
    B -->|å¦| D[æ‰§è¡Œæ“ä½œ2]
    C --> E[ç»“æŸ]
    D --> E`,
            
            sequence: `sequenceDiagram
    participant Alice
    participant Bob
    Alice->>Bob: ä½ å¥½ Bob
    Bob->>Alice: ä½ å¥½ Alice
    Alice->>Bob: æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ
    Bob->>Alice: å¾ˆå¥½ï¼Œè°¢è°¢ï¼`,
            
            class: `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat`,
            
            state: `stateDiagram-v2
    [*] --> å¾…å¤„ç†
    å¾…å¤„ç† --> å¤„ç†ä¸­: å¼€å§‹å¤„ç†
    å¤„ç†ä¸­ --> å·²å®Œæˆ: å®Œæˆ
    å¤„ç†ä¸­ --> å¤±è´¥: å‡ºé”™
    å¤±è´¥ --> å¾…å¤„ç†: é‡è¯•
    å·²å®Œæˆ --> [*]`,
            
            er: `erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    CUSTOMER {
        string name
        string email
        string phone
    }
    ORDER {
        int orderNumber
        date orderDate
        string status
    }
    LINE-ITEM {
        string productCode
        int quantity
        float price
    }`,
            
            gantt: `gantt
    title é¡¹ç›®å¼€å‘è®¡åˆ’
    dateFormat  YYYY-MM-DD
    section éœ€æ±‚åˆ†æ
    éœ€æ±‚æ”¶é›†           :a1, 2024-01-01, 7d
    éœ€æ±‚è¯„å®¡           :after a1, 3d
    section è®¾è®¡é˜¶æ®µ
    æ¶æ„è®¾è®¡           :2024-01-11, 5d
    è¯¦ç»†è®¾è®¡           :2024-01-16, 7d
    section å¼€å‘é˜¶æ®µ
    å‰ç«¯å¼€å‘           :2024-01-23, 14d
    åç«¯å¼€å‘           :2024-01-23, 14d`
        };
        
        // ç›‘å¬æ¥è‡ª draw.io çš„æ¶ˆæ¯
        window.addEventListener('message', function(evt) {
            // ç¡®ä¿æ¶ˆæ¯æ¥è‡ª iframe
            if (evt.source !== iframe.contentWindow) {
                return;
            }
            
            let data;
            try {
                data = typeof evt.data === 'string' ? JSON.parse(evt.data) : evt.data;
            } catch (e) {
                return;
            }
            
            console.log('Received message from draw.io:', data);
            
            // å¤„ç† iframe å°±ç»ªäº‹ä»¶ - éœ€è¦å‘é€ load æ¶ˆæ¯æ¥åˆå§‹åŒ–ç¼–è¾‘å™¨
            if (data.event === 'init') {
                console.log('Draw.io init received, sending load message...');
                // å‘é€ç©ºç™½æ–‡æ¡£æ¥åˆå§‹åŒ–ç¼–è¾‘å™¨
                iframe.contentWindow.postMessage(JSON.stringify({
                    action: 'load',
                    xml: '<mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel>',
                    autosave: 0
                }), '*');
            }
            
            // å¤„ç†åŠ è½½å®Œæˆäº‹ä»¶ - åŠ¨æ€åŠ è½½æ’ä»¶
            if (data.event === 'load') {
                console.log('Draw.io loaded, injecting mermaid-import plugin...');
                // é€šè¿‡ script æ ‡ç­¾åŠ¨æ€åŠ è½½æ’ä»¶åˆ° iframe
                var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                var script = iframeDoc.createElement('script');
                script.src = '/src/main/webapp/plugins/mermaid-import.js';
                script.onload = function() {
                    console.log('Mermaid import plugin script loaded');
                };
                script.onerror = function() {
                    console.error('Failed to load mermaid import plugin');
                };
                iframeDoc.head.appendChild(script);
            }
            
            // å¤„ç†æ’ä»¶å°±ç»ªäº‹ä»¶
            if (data.event === 'mermaid-import-ready') {
                iframeReady = true;
                showStatus('Draw.io å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ç”Ÿæˆå›¾è¡¨', 'info');
                console.log('Draw.io iframe ready with mermaid plugin');
            }
            
            // å¤„ç† generateMermaid å“åº”
            if (data.event === 'generateMermaid') {
                if (data.status === 'ok') {
                    const cellCount = data.data?.cellCount || 0;
                    showStatus(`âœ… å›¾è¡¨ç”ŸæˆæˆåŠŸï¼æ’å…¥äº† ${cellCount} ä¸ªå›¾å½¢å…ƒç´ `, 'success');
                    console.log('Diagram generated successfully:', data);
                } else {
                    showStatus(`âŒ å›¾è¡¨ç”Ÿæˆå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    console.error('Diagram generation failed:', data);
                }
            }
            
            // å¤„ç† modifyStyle å“åº”
            if (data.event === 'modifyStyle') {
                if (data.status === 'ok') {
                    const modifiedCount = data.data?.modifiedCount || 0;
                    showStyleStatus(`âœ… æ“ä½œæˆåŠŸï¼ä¿®æ”¹äº† ${modifiedCount} ä¸ªå…ƒç´ `, 'success');
                    console.log('Style modification successful:', data);
                } else {
                    showStyleStatus(`âŒ æ ·å¼ä¿®æ”¹å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'} (${data.errorCode || 'UNKNOWN'})`, 'error');
                    console.error('Style modification failed:', data);
                }
            }
        });
        
        // ç”Ÿæˆå›¾è¡¨
        function generateDiagram() {
            const mermaidText = document.getElementById('mermaid-input').value.trim();
            const editable = document.getElementById('editable-option').checked;
            
            if (!mermaidText) {
                showStatus('âš ï¸ è¯·è¾“å…¥ Mermaid æ–‡æœ¬', 'error');
                return;
            }
            
            if (!iframeReady) {
                showStatus('â³ Draw.io æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...', 'info');
                // ç­‰å¾… iframe å°±ç»ªåé‡è¯•
                setTimeout(generateDiagram, 1000);
                return;
            }
            
            const modeText = editable ? 'åŸç”Ÿå¯ç¼–è¾‘å›¾å½¢' : 'Mermaid æ•°æ®å›¾å½¢';
            showStatus(`ğŸ”„ æ­£åœ¨ç”Ÿæˆ${modeText}...`, 'info');
            
            // å‘é€æ¶ˆæ¯åˆ° draw.io iframe
            iframe.contentWindow.postMessage(JSON.stringify({
                action: 'generateMermaid',
                mermaid: mermaidText,
                options: {
                    position: { x: 50, y: 50 },
                    select: true,
                    center: false,
                    editable: editable  // true = åŸç”Ÿå›¾å½¢, false = Mermaid æ•°æ®
                }
            }), '*');
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status-section ' + type;
            
            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('mermaid-input').value = '';
            statusDiv.style.display = 'none';
        }
        
        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            if (examples[type]) {
                document.getElementById('mermaid-input').value = examples[type];
                showStatus(`å·²åŠ è½½ ${type} ç¤ºä¾‹`, 'info');
            }
        }
        
        // æ”¯æŒ Ctrl+Enter å¿«æ·é”®ç”Ÿæˆå›¾è¡¨
        document.getElementById('mermaid-input').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                generateDiagram();
            }
        });
        
        // ========================================
        // æ ·å¼ä¿®æ”¹åŠŸèƒ½
        // ========================================
        
        // æ ·å¼ä¿®æ”¹ç¤ºä¾‹
        const styleExamples = {
            changeColor: {
                action: 'modifyStyle',
                target: 'selected',
                styles: {
                    fillColor: '#FF6B6B',
                    strokeColor: '#4ECDC4'
                }
            },
            
            thickenLines: {
                action: 'modifyStyle',
                target: 'selected',
                operations: {
                    strokeWidth: { op: 'increase', value: 2 }
                }
            },
            
            addShadow: {
                action: 'modifyStyle',
                target: 'selected',
                styles: {
                    shadow: 1,
                    rounded: 1
                }
            },
            
            roundCorners: {
                action: 'modifyStyle',
                target: 'selected',
                styles: {
                    rounded: 1,
                    arcSize: 20
                }
            },
            
            changeFont: {
                action: 'modifyStyle',
                target: 'selected',
                styles: {
                    fontSize: 16,
                    fontColor: '#2C3E50',
                    fontFamily: 'Arial'
                }
            },
            
            relativeOps: {
                action: 'modifyStyle',
                target: 'selected',
                operations: {
                    fontSize: { op: 'increase', value: 4 },
                    strokeWidth: { op: 'multiply', value: 1.5 },
                    opacity: { op: 'decrease', value: 10 }
                }
            },
            
            edgeArrows: {
                action: 'modifyStyle',
                target: 'edges',
                styles: {
                    startArrow: 'classic',
                    endArrow: 'block',
                    strokeWidth: 3,
                    strokeColor: '#E74C3C'
                }
            },
            
            combined: {
                action: 'modifyStyle',
                target: 'selected',
                styles: {
                    fillColor: '#3498DB',
                    strokeColor: '#2C3E50',
                    rounded: 1,
                    shadow: 1
                },
                operations: {
                    strokeWidth: { op: 'set', value: 3 },
                    fontSize: { op: 'increase', value: 2 }
                }
            }
        };
        
        // åº”ç”¨æ ·å¼ä¿®æ”¹
        function applyStyleModification() {
            const styleInput = document.getElementById('style-input').value.trim();
            
            if (!styleInput) {
                showStyleStatus('âš ï¸ è¯·è¾“å…¥æ ·å¼ä¿®æ”¹ JSON æŒ‡ä»¤', 'error');
                return;
            }
            
            if (!iframeReady) {
                showStyleStatus('â³ Draw.io æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...', 'info');
                setTimeout(applyStyleModification, 1000);
                return;
            }
            
            let styleCommand;
            try {
                styleCommand = JSON.parse(styleInput);
            } catch (e) {
                showStyleStatus('âŒ JSON æ ¼å¼é”™è¯¯ï¼š' + e.message, 'error');
                return;
            }
            
            // éªŒè¯å¿…éœ€å­—æ®µ
            if (!styleCommand.action) {
                showStyleStatus('âŒ ç¼ºå°‘ action å­—æ®µ', 'error');
                return;
            }
            
            showStyleStatus('ğŸ”„ æ­£åœ¨åº”ç”¨æ ·å¼ä¿®æ”¹...', 'info');
            
            // å‘é€æ¶ˆæ¯åˆ° draw.io iframe
            iframe.contentWindow.postMessage(JSON.stringify(styleCommand), '*');
        }
        
        // æ˜¾ç¤ºæ ·å¼ä¿®æ”¹çŠ¶æ€æ¶ˆæ¯
        function showStyleStatus(message, type) {
            const styleStatusDiv = document.getElementById('style-status');
            styleStatusDiv.textContent = message;
            styleStatusDiv.className = 'status-section ' + type;
            
            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    styleStatusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // æ¸…ç©ºæ ·å¼è¾“å…¥
        function clearStyleInput() {
            document.getElementById('style-input').value = '';
            const styleStatusDiv = document.getElementById('style-status');
            styleStatusDiv.style.display = 'none';
        }
        
        // åŠ è½½æ ·å¼ä¿®æ”¹ç¤ºä¾‹
        function loadStyleExample(type) {
            if (styleExamples[type]) {
                document.getElementById('style-input').value = JSON.stringify(styleExamples[type], null, 2);
                showStyleStatus(`å·²åŠ è½½ ${getExampleName(type)} ç¤ºä¾‹`, 'info');
            }
        }
        
        // è·å–ç¤ºä¾‹åç§°
        function getExampleName(type) {
            const names = {
                changeColor: 'æ”¹å˜é¢œè‰²',
                thickenLines: 'åŠ ç²—çº¿æ¡',
                addShadow: 'æ·»åŠ é˜´å½±',
                roundCorners: 'åœ†è§’æ•ˆæœ',
                changeFont: 'ä¿®æ”¹å­—ä½“',
                relativeOps: 'ç›¸å¯¹æ“ä½œ',
                edgeArrows: 'ç®­å¤´æ ·å¼',
                combined: 'ç»„åˆä¿®æ”¹'
            };
            return names[type] || type;
        }
        
        // æ”¯æŒ Ctrl+Enter å¿«æ·é”®åº”ç”¨æ ·å¼ä¿®æ”¹
        document.getElementById('style-input').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                applyStyleModification();
            }
        });
    </script>
</body>
</html>
