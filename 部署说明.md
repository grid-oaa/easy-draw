# Easy Draw 部署文档（Vercel + Render）

本文档覆盖：
- 生产环境配置与 CORS 配置
- 前端 Vue 上线到 Vercel（https://vercel.com/）
- 后端 Spring Boot（Jar）上线到 Render（https://dashboard.render.com/）
- draw.io 上线到 Render，静态站点部署

后端地址
https://easy-draw.onrender.com/api/ai/demo

前端地址
https://easy-draw-bv89kjjsa-grid-oaas-projects.vercel.app/editor

draw地址
https://drawio-dwy3.onrender.com/

---

## 后端 CORS 配置（必须）
要需要允许前端域名访问。

新增一个配置类：
`backend/src/main/java/com/easydraw/backend/config/WebCorsConfig.java`

```java
package com.easydraw.backend.config;

import java.util.stream.Stream;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebCorsConfig implements WebMvcConfigurer {

    // 通过环境变量获取允许的域名
   @Value("${app.allowed-origins:https://easy-draw.vercel.app}")
   private String allowedOrigins;

   @Override
   public void addCorsMappings(CorsRegistry registry) {
      String[] origins =
              Stream.of(allowedOrigins.split(","))
                      .map(String::trim)
                      .filter((value) -> !value.isEmpty())
                      .toArray(String[]::new);

      if (origins.length == 0) {
         origins = new String[] {"https://easy-draw.vercel.app"};
      }

      registry
              .addMapping("/api/**")
              .allowedOrigins(origins)
              .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
              .allowedHeaders("*")
              .allowCredentials(true);
   }
}
```

> 注意：用环境变量替换成真实前端域名。

---

## 后端部署（Render）
1. 推送代码到 GitHub。
2. Render 上新建 **Web Service**（Java）。
3. Language：
   ```
   选择docker（根目录要有Dockerfile文件才行）
   ```
---

## draw.io 部署（必需）
项目依赖本地 draw.io（带 `mermaid-import` 插件）。
将 draw.io 源码部署为静态站点。

### 方式 A：Render Static Site（推荐）
1. 把 draw.io 解压目录（如 `drawio-29.2.9`）推到一个独立 Git 仓库。
2. 确保插件文件存在：
   ```
   src/main/webapp/plugins/mermaid-import.js
   ```
3. Render 新建 **Static Site**：
   - Build Command：留空
   - Publish Directory：
     ```
     src/main/webapp
     ```
4. 部署完成得到 draw.io 域名：
   ```
   https://your-drawio.onrender.com
   ```

### 方式 B：Vercel/Cloudflare Pages
同样将 `drawio-29.2.9/src/main/webapp` 作为静态目录发布即可。

---

## 前端 draw.io 地址配置
在前端配置 draw.io 基础 URL：

`.env.production` 示例：
```
VUE_APP_DRAWIO_BASE_URL=https://your-drawio.onrender.com
```

---

## 前端 API 配置（生产环境）
当前 `frontend/src/api/http.js` 里 `baseURL` 是固定的 `/api`：

```js
baseURL: '/api'
```

在生产环境可以用两种方式：

### 方案 A（推荐）：Vercel Rewrite
在 Vercel 设置中添加 Rewrite，将 `/api/*` 转发到后端：
```
/api/(.*)  ->  https://your-backend.onrender.com/api/$1
```
这样前端仍然用 `/api`，无需改代码。

### 方案 B：显式配置 baseURL
修改 `http.js`：
```js
baseURL: process.env.VUE_APP_API_BASE_URL || '/api'
```
然后在 Vercel 环境变量中配置：
```
VUE_APP_API_BASE_URL=https://your-backend.onrender.com/api
```

---

## 前端部署（Vercel）
1. Vercel 导入 GitHub 仓库。
2. Build Command：
   ```
   npm run build
   ```
3. Output Directory：
   ```
   dist
   ```
4. Install Command：
   ```
   npm install
   ```
5. Root Directory：
   ```
   frontend
   ```
6. 部署完成后得到前端域名：
   ```
   https://easy-draw-bv89kjjsa-grid-oaas-projects.vercel.app/
   ```

